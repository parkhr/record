<template>
  <a-card title="최근 리스트" bordered>
    <a-table
      :columns="columns"
      :data-source="balances"
      :row-key="record => record.id"
      size="middle"
      bordered
      :pagination="false"
    >
      <template #amount="{ record }">
        <span :style="{ color: record.amount >= 0 ? '#52c41a' : '#f5222d' }">
          ₩ {{ formatNumber(record.amount) }}
        </span>
      </template>

      <template #status="{ record }">
        <a-tag :color="record.status == 'ACTIVE' || record.status == 'SPEND' ? 'green' : 'red'">
          {{ getStatusLabel(record.status) }}
        </a-tag>
      </template>
    </a-table>
  </a-card>
</template>

<script setup>
import api from '@/api/axios';
import { message } from 'ant-design-vue';
import { onMounted, ref } from 'vue';

// 내부 상태로 가진 잔액 데이터
const balances = ref([]);

const formatNumber = (num) => num?.toLocaleString() ?? '0';

const columns = [
  {
    title: '잔액',
    key: 'amount',
    slots: { customRender: 'amount' },
  },
  {
    title: '상태',
    key: 'status',
    slots: { customRender: 'status' },
    align: 'center',
  },
  {
    title: '날짜',
    dataIndex: 'date',
    key: 'date',
  }
];

const getStatusLabel = (status) => {
  switch (status) {
    case 'ACTIVE':
      return '적립'
    case 'SPEND':
      return '차감'
    case 'CANCEL_ACTIVE':
      return '적립 취소'
    case 'CANCEL_SPEND':
      return '차감 취소'
    default:
      return status
  }
}

const fetchRecent = async () => {
  try {
    const response = await api.get('/api/economy/dashboard/recent', {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${sessionStorage.getItem('accessToken')}`
      }
    });
    if(response.status !== 200) throw new Error();

    balances.value = response.data;
  } catch (error) {
    message.error('최근리스트를 불러올 수 없습니다.');
  }
}

onMounted(() => {
  fetchRecent();
})
</script>
